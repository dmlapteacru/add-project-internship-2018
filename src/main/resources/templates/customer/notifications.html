<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">

<head>
    <title>Notifications</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/header.css"/>
    <link rel="stylesheet" href="/css/alert.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/notifications.css}"/>
    <script src="/webjars/jquery/3.1.0/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/1.0.2/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.3/stomp.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>
</head>

<body>
<div class="modal fade" id="load_icon_wrapper" data-backdrop="static" data-keyboard="false">
    <img id="load" src="/img/load_icon.gif"/>
</div>
<div th:replace="fragments/header :: header"></div>
<div class="page_title">
    <div class="title">
        <span>Notifications</span>
    </div>
    <div class="description">
        <span>Manage your notifications the way you like.</span>
    </div>
</div>
<div class="wrapper">
    <div class="center_">
        <div class="notifications_wrapper">
        </div>
        <a id="load_notifications">Load more</a>
    </div>
</div>
<div id="alert_success" class="alert alert-success alert-dismissible fade in">
    <div id="approval_info">
        <strong id="confirm_alert_message"></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
</div>
<div id="alert_error" class="alert alert-danger alert-dismissible fade in">
    <div id="alert_error_info">
        <strong id="error_alert_message"></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
</div>
<script src="/js/loadbalance.js"></script>
<script src="/js/user-websock.js"></script>
<script src="/js/customer-sock-distribute.js"></script>
<script>
    var isScrolled = true;
    var scrollContext = 3;
    var page = 0;
    $(document).ready(function () {
        getNotifications(page);
    });

    function getNotifications(page) {
        $.ajax(
            {
                url: "/customerRest/notifications/view?page=" + page,
                beforeSend: function () {
                    $("#load_icon_wrapper").modal("show");
                },
                success: function (result) {
                    printNotificationsByPages(result);
                    $("#load_icon_wrapper").modal("hide");
                    isScrolled = true;
                }
            }
        )
    }
    
    function printNotificationsByPages(result) {
        $.each(result, function (id, obj) {
            $(".notifications_wrapper").append(
                "<div class='notification_'>" +
                    "<div class='notification_message'>" +
                        "<div class='notification_message_content'>" +
                            "<span>" + obj.content +" by <b>"+ obj.userFrom + "</b></span>" +
                        "</div>"+
                        "<div class='date'>" + parseDate(obj.date) + "</div>"+
                    "</div>" +
                    "<div class='notification_buttons'>" +
                        "<div class='mark_as_read'>" +
                            "<button id='" + obj.id + "' onclick='markAsRead(this)' data-status='"+obj.status+"'>" +
                                "<span><i class='fas fa-check'></i></span><span>Mark as read</span>" +
                            "</button>" +
                        "</div>" +
                        "<div class='view_notification'>" +
                            "<a id='"+ obj.id + "' data-case='" + obj.notificationCase + "' onclick='goThroughView(this,"+ obj.id +")'>View</a>" +
                        "</div>"+
                    "</div>" +
                "</div>"
            );
        });
        deleteMarkAsReadButtons();
    }
    function deleteMarkAsReadButtons() {
        $.each($(".mark_as_read > button"), function (id, link) {
            if ($(link).attr("data-status")==="READ"){
                $(link).css("display", "none");
            }
        })
    }
    
    function parseDate(date) {
        var minutes = "";
        if (date[4]<10){
            minutes = "0" + date[4];
        } else minutes = date[4];
        return date[2] + "-" + date[1] + "-" + date[0] + " " + date[3] + ":" + minutes;
    }

    $("#load_notifications").click(function () {
        page+=1;
        getNotifications(page);
    });
</script>
</body>
</html>